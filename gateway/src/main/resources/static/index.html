<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaClaw Control</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; }
        .header { background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .status { font-size: 12px; padding: 2px 8px; border-radius: 12px; background: #238636; color: #fff; }
        .header .status.disconnected { background: #da3633; }
        .container { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 57px); }
        .sidebar { background: #161b22; border-right: 1px solid #30363d; overflow-y: auto; }
        .sidebar h2 { font-size: 14px; padding: 12px 16px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
        .session-item { padding: 10px 16px; border-bottom: 1px solid #21262d; cursor: pointer; }
        .session-item:hover { background: #1f2937; }
        .session-item .id { font-size: 12px; color: #8b949e; font-family: monospace; }
        .session-item .meta { font-size: 11px; color: #484f58; margin-top: 4px; }
        .main { display: flex; flex-direction: column; }
        .toolbar { padding: 12px 16px; border-bottom: 1px solid #30363d; display: flex; gap: 8px; }
        .toolbar button { padding: 6px 16px; border-radius: 6px; border: 1px solid #30363d; background: #21262d; color: #c9d1d9; cursor: pointer; font-size: 13px; }
        .toolbar button:hover { background: #30363d; }
        .toolbar button.primary { background: #238636; border-color: #238636; color: #fff; }
        .events { flex: 1; overflow-y: auto; padding: 16px; font-family: monospace; font-size: 13px; }
        .event { padding: 4px 0; border-bottom: 1px solid #21262d; }
        .event .type { color: #58a6ff; }
        .event .ts { color: #484f58; font-size: 11px; }
        .input-bar { padding: 12px 16px; border-top: 1px solid #30363d; display: flex; gap: 8px; }
        .input-bar input { flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: #c9d1d9; font-size: 14px; }
        .input-bar button { padding: 8px 20px; border-radius: 6px; border: none; background: #238636; color: #fff; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1>JavaClaw</h1>
        <span id="ws-status" class="status disconnected">Disconnected</span>
    </div>
    <div class="container">
        <div class="sidebar">
            <h2>Sessions</h2>
            <div id="session-list"></div>
            <div style="padding: 12px 16px;">
                <button onclick="createSession()" style="width:100%;padding:8px;border-radius:6px;border:1px solid #30363d;background:#21262d;color:#c9d1d9;cursor:pointer;">+ New Session</button>
            </div>
        </div>
        <div class="main">
            <div class="toolbar">
                <button class="primary" onclick="runSession()">Run</button>
                <button onclick="pauseSession()">Pause</button>
                <button onclick="resumeSession()">Resume</button>
            </div>
            <div id="events" class="events">
                <div style="color:#484f58;padding:40px;text-align:center;">Select or create a session to begin</div>
            </div>
            <div class="input-bar">
                <input id="msg-input" type="text" placeholder="Send a message..." onkeypress="if(event.key==='Enter')sendMsg()">
                <button onclick="sendMsg()">Send</button>
            </div>
        </div>
    </div>
    <script>
        let ws = null;
        let currentSession = null;

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);
            ws.onopen = () => {
                document.getElementById('ws-status').textContent = 'Connected';
                document.getElementById('ws-status').classList.remove('disconnected');
                if (currentSession) subscribe(currentSession);
            };
            ws.onclose = () => {
                document.getElementById('ws-status').textContent = 'Disconnected';
                document.getElementById('ws-status').classList.add('disconnected');
                setTimeout(connect, 2000);
            };
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'EVENT') appendEvent(msg.payload);
            };
        }

        function subscribe(sessionId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'SUBSCRIBE_SESSION', sessionId, payload: null, ts: new Date().toISOString() }));
            }
        }

        function appendEvent(event) {
            const el = document.getElementById('events');
            const div = document.createElement('div');
            div.className = 'event';
            div.innerHTML = `<span class="ts">${event.timestamp || ''}</span> <span class="type">${event.type || ''}</span> ${JSON.stringify(event.payload || '')}`;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        async function loadSessions() {
            const res = await fetch('/api/sessions');
            const sessions = await res.json();
            const list = document.getElementById('session-list');
            list.innerHTML = sessions.map(s => `
                <div class="session-item" onclick="selectSession('${s.sessionId}')">
                    <div class="id">${s.sessionId.substring(0, 8)}...</div>
                    <div class="meta">${s.status} | ${s.modelConfig?.modelName || 'default'}</div>
                </div>
            `).join('');
        }

        function selectSession(id) {
            currentSession = id;
            document.getElementById('events').innerHTML = '';
            subscribe(id);
        }

        async function createSession() {
            await fetch('/api/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            loadSessions();
        }

        async function sendMsg() {
            if (!currentSession) return;
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if (!content) return;
            await fetch(`/api/sessions/${currentSession}/messages`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, role: 'user' })
            });
            input.value = '';
        }

        async function runSession() { if (currentSession) await fetch(`/api/sessions/${currentSession}/run`, { method: 'POST' }); }
        async function pauseSession() { if (currentSession) await fetch(`/api/sessions/${currentSession}/pause`, { method: 'POST' }); }
        async function resumeSession() { if (currentSession) await fetch(`/api/sessions/${currentSession}/resume`, { method: 'POST' }); }

        connect();
        loadSessions();
    </script>
</body>
</html>
